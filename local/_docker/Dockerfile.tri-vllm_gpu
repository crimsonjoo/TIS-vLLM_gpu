# Ubuntu 22.04를 기반 이미지로 사용
FROM nvcr.io/nvidia/tritonserver:25.02-vllm-python-py3

# Build arguments for PyPI credentials
ARG PYPI_USERNAME
ARG PYPI_PASSWORD

# 환경 변수 설정
ENV DEBIAN_FRONTEND=noninteractive

# 기본 패키지 설치 및 SSH 설정
RUN apt-get update && \
    apt-get install -y \
    libgl1 \
    tmux \
    openssh-server \
    python3 \
    python3-pip \
    git \
    nano \
    vim \
    tini \
    && rm -rf /var/lib/apt/lists/*

# SSH 설정
RUN mkdir /var/run/sshd && \
    echo 'root:root' | chpasswd && \
    sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config && \
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config && \
    sed -i 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/' /etc/ssh/sshd_config && \
    ssh-keygen -A

# Python pip 설정 및 패키지 설치
## pip 업그레이드 시도 없이 직접 필요한 패키지 설치
RUN mkdir -p /root/.pip && \
    python3 -m pip install --no-cache-dir \
    pyyaml \
    numpy \
    "tritonclient[all]" \
    fastapi \
    uvicorn \
    pydantic \
    requests \
    --break-system-packages

# /tmp 디렉토리 생성 및 권한 설정
RUN mkdir -p /tmp && chmod 1777 /tmp

# 애플리케이션 디렉토리 설정
WORKDIR /workspace

# 필요한 디렉토리 생성
RUN mkdir -p /workspace/local

# container 내부의 모든 파일들을 그대로 /workspace안에 복사
COPY ./container/ /workspace/

# 포트 노출 (SSH + 추가 서비스)
EXPOSE 22 5000 8000 8001 8002 42435

# 시작 스크립트 생성
COPY ./local/_docker/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# 시작 명령 설정
ENTRYPOINT ["/usr/bin/tini", "--", "/entrypoint.sh"]
